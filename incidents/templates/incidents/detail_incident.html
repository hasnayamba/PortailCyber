{% extends 'incidents/base.html' %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
<h2>Bienvenue, {{ user.username }} !</h2>
<p>Rôle : {{ user.role|capfirst }}</p>

<body class="bg-light">
<div class="container mt-5">

    {% if messages %}
  <div>
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

    
    <h2 class="mb-4">📍 Détail du signalement #{{ incident.id }}</h2>
    <a href="{% url 'gestion_incidents' %}" class="btn btn-secondary mb-4">⬅ Retour à la liste</a>

    <div class="mb-3"><strong>Type :</strong> {{ incident.get_type_incident_display }}</div>
    <div class="mb-3"><strong>Utilisateur :</strong> {{ incident.user.username }}</div>
    <div class="mb-3"><strong>Description :</strong> {{ incident.description }}</div>
    <div class="mb-3"><strong>Date :</strong> {{ incident.date_signalement|date:"d/m/Y H:i" }}</div>

    <!-- Géolocalisation améliorée -->
    <div class="mb-3">
        <strong>Géolocalisation :</strong>
        {% if incident.geolocalisation %}
            <a href="https://www.google.com/maps/search/?api=1&query={{ incident.geolocalisation }}"
               class="btn btn-sm btn-outline-primary ms-2"
               target="_blank">
               📍 Voir sur Google Maps
            </a>
            <div class="mt-2 text-muted">Coordonnées : {{ incident.geolocalisation }}</div>

            <!-- Carte intégrée -->
            <div class="mt-3">
                <iframe
                    width="100%"
                    height="300"
                    style="border:0; border-radius: 8px;"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps/embed/v1/place?key=VOTRE_CLE_API&q={{ incident.geolocalisation }}">
                </iframe>
            </div>
        {% else %}
            <span class="text-danger ms-2">Non renseignée</span>
        {% endif %}
    </div>

    <!-- Preuves -->
    <div class="mb-3">
        <strong>Preuves :</strong><br/>
        {% if incident.preuve_image %}
            📷 <a href="{{ incident.preuve_image.url }}" target="_blank">Image</a><br/>
        {% endif %}
        {% if incident.preuve_video %}
            🎥 <a href="{{ incident.preuve_video.url }}" target="_blank">Vidéo</a><br/>
        {% endif %}
        {% if incident.preuve_log %}
            📄 <a href="{{ incident.preuve_log.url }}" target="_blank">Log</a><br/>
        {% endif %}
        {% if not incident.preuve_image and not incident.preuve_video and not incident.preuve_log %}
            <span class="text-muted">Aucune preuve fournie</span>
        {% endif %}
        {% if incident.deepfake_score %}
        <div class="alert alert-warning mt-3">
            <h5>Détection Deepfake</h5>
            <p><strong>Score de probabilité :</strong> {{ incident.deepfake_score|floatformat:2 }}</p>
            <p><strong>Rapport :</strong> {{ incident.deepfake_rapport }}</p>
            <p><em>Analyse effectuée le {{ incident.deepfake_analyse_date|date:"d/m/Y H:i" }}</em></p>
        </div>
        {% endif %}
    </div>

        <h4>💬 Commentaires</h4>
    <div>
        {% for commentaire in incident.commentaires.all %}
            <div class="border rounded p-2 mb-2">
                <small class="text-muted">{{ commentaire.user.username }} - {{ commentaire.date_creation|date:"d/m/Y H:i" }}</small>
                <p>{{ commentaire.contenu }}</p>
            </div>
        {% empty %}
            <p class="text-muted">Pas encore de commentaires.</p>
        {% endfor %}
    </div>

    <!-- Formulaire ajout commentaire -->
    <form method="post" action="{% url 'ajouter_commentaire' incident.id %}">
        {% csrf_token %}
        <textarea name="contenu" rows="3" class="form-control" placeholder="Ajouter un commentaire..." required></textarea>
        <button type="submit" class="btn btn-primary mt-2">Envoyer</button>
    </form>
    <!-- Formulaire de changement de statut -->
    <form method="post" action="" class="border rounded p-3 bg-white shadow-sm">
        {% csrf_token %}
        <label for="statut" class="form-label">Modifier le statut :</label>
        <select name="statut" id="statut" class="form-select mb-3" required>
            <option value="en_attente" {% if incident.statut == 'en_attente' %}selected{% endif %}>En attente</option>
            <option value="en_cours" {% if incident.statut == 'en_cours' %}selected{% endif %}>En cours</option>
            <option value="resolu" {% if incident.statut == 'resolu' %}selected{% endif %}>Résolu</option>
        </select>

        {% if incident.preuve_image or incident.preuve_video %}
            <a href="{% url 'analyser_deepfake' incident.id %}" class="btn btn-warning mt-3">
                🔍 Analyser Deepfake
            </a>
        {% endif %}
        
        <button type="submit" class="btn btn-success mt-3">💾 Sauvegarder</button>
    </form>
</div>
</body>
{% endblock %}
